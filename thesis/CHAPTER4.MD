# Работа с запросами #

## Добавление комментариев к запросам ##

Комментарии — это простые предложения, которые помогают понять логику вашего SQL-запроса. Использование комментариев в
SQL очень полезно, так как они поясняют сложную логику запроса.

В SQL комментарии бывают двух типов. Однострочные начинаются с двух дефисов (--) и многострочные комментарии начинаются
с сочетания символов /* и заканчиваются символами */. Все, что находится между открывающим и закрывающим символами, —
это комментарии

**_Однострочный_**

```sqlite
--This is a line of comment
SELECT *
FROM albums;
```

**_Многострочный_**

```sqlite
/*
CREATED BY: O.SUROVTSEV
CREATED ON: 01/10/2023
DESCRIPTION: This script select all of the records from the album table
*/
SELECT *
FROM albums;
```

В примере приведена стандартная информация, которую полезно включать в блок комментариев. Разработчик, дата разработки и
описание имеют большое значение для всех, кто сталкивается с SQL-запросом или сценарием.

**При работе с реальными базами данных использование комментариев экономит время, которое пришлось бы потратить на
написание дополнительных запросов, чтобы прояснить работу базы данных. Комментарии особенно важны, когда
ваши запросы используются другими разработчиками.**

## Общая структура запроса ##

Написать запрос — это то же самое, что задать вопрос на любом человеческом языке. Большое значение имеют формулировка,
детали и порядок слов. Чем детальнее наш вопрос, тем точнее будет ответ.

При создании SQL-запроса необходимо учитывать следующие пять моментов.

1. С какой базой данных мы работаем?
2. Из какой таблицы в этой базе данных нам необходимо извлечь данные?
3. Какие поля в этой таблице нас интересуют?
4. Хотим ли мы исключить какие-либо данные, отфильтровать или исключить какой-либо диапазон или период времени?
5. Как сформулировать наш запрос одним простым предложением на человеческом языке?

Цель этих вопросов — построить взаимосвязь между человеческим языком, на котором мы обычно говорим или пишем, и языком
SQL.

Пример:

1. С какой базой данных мы работаем? В этом случае мы будем работать только с одной базой данных. База данных
   sTunes уже должна быть открыта в DB Browser.
2. Из какой таблицы в этой базе данных нам необходимо извлечь данные? Нам необходимо получить информацию о клиентах.
   Просматривая вкладку Database Structure (Структура базы данных), мы видим, что у нас есть таблица с именем
   customers (клиенты).
3. Какие поля в этой таблице нас интересуют? Таблица содержит поля для имени, фамилии и электронной почты.
4. Хотим ли мы исключить какие-либо данные, отфильтровать или исключить какой-либо диапазон или период времени?
   В данном случае служба поддержки sTunes желает получить список всех клиентов, поэтому лучше ничего не исключать.
5. Как сформулировать наш запрос одним простым предложением на человеческом языке?
   С помощью запроса нам необходимо осуществить выборку следующей информации из таблицы customers: имя, фамилия и адрес
   электронной почты.

```sqlite
/*
CREATED BY: O.SUROVTSEV
CREATED ON: 01/10/2023
DESCRIPTION: This script select all of the records from the album table
*/
SELECT FirstName,
       LastName,
       Email
FROM customers;
```

## Синтаксис и соглашение о кодировании ## 

Как уже упоминалось в главе 1, все запросы должны соответствовать определенному синтаксису, чтобы их мог понять браузер
SQL. Однако при написании запросов необходимо учитывать еще кое-что. Важно, чтобы другие пользователи базы данных могли
легко понять ваши запросы. Набор принципов, которые задают стиль, методы написания запросов и т. д., известен как
соглашение о кодировании. Для разных сред баз данных соглашения о кодировании различаются.

В предыдущих примерах после ключевого слова SELECT мы использовали символ `*` вместо указания отдельных полей. С помощью
специального символа `*`осуществляется выборка всех записей из таблицы. В некоторых случаях этот символ полезен. Однако
чаще рекомендуется указывать необходимые поля. Здесь точку с запятой в конце оператора ставить необязательно, так как мы
пишем только один оператор SQL. Точка с запятой обозначает конец оператора SQL. Поскольку большинство SQL-запросов,
используемых в этой книге, представляют собой отдельные операторы, точку с запятой мы будем в дальнейшем опускать.

В примере в условии SELECT определили три поля для отображения. Каждое поле необходимо отделять запятой (кроме
последнего). Отсутствие запятой между полями или наличие ее после последнего поля — это распространенные синтаксические
ошибки, о которых вы получите сообщение на панели результатов.

Код состоит из нескольких строк. Также запрос можно написать в одной строке, и браузер SQL по-прежнему распознает код и
вернет результаты. Однако запросы рекомендуется разделять на условия, при этом каждое условие необходимо писать с новой
строки. Использование отступов и пробелов в запросах повышает удобочитаемость и значительно упрощает понимание сложной
логики запроса.

## Использование псевдонима (alias) ##

Как правило, технический язык базы данных отличается от общепринятого языка. Часто приходиться работать со старыми
базами данных или базами данных, имена полей которых давно не обновлялись. Псевдонимы SQL используются для присвоения
таблице или столбцу в таблице временного имени. Псевдонимы часто используются для того, чтобы сделать имена столбцов
более удобочитаемыми. Псевдоним существует только на время выполнения запроса.

Далее показаны различные способы создания псевдонима для выбранных имен полей из таблицы customers.
Псевдоним в базе данных всегда указывают сразу после имени поля. Псевдонимы обычно связаны с ключевым словом AS, однако
в большинстве реализаций РСУБД ключевое слово AS между именем поля и псевдонимом использовать необязательно.

```sqlite
/*
CREATED BY: O.SUROVTSEV
CREATED ON: 01/10/2023
DESCRIPTION: Данный запрос осуществляет выборку полей имени, фамилии, 
электронной почты и номера телефона из таблицы customers (клиенты) 
и демонстрирует четыре различных способа использования псевдонима.
*/
SELECT FirstName AS 'First Name',
       LastName  AS [Last Name],
       Email     AS EMAIL,
       Phone        CELL
FROM customers
```

Если созданный вами псевдоним содержит несколько слов (например,имя и фамилию), его необходимо разграничить, в данном
случае либо одинарными кавычками '', либо квадратными скобками []. Поскольку псевдонимы EMAIL и CELL представляют собой
отдельные слова, нет необходимости их заключать в кавычки или скобки. **Псевдонимы изменяют только способ отображения
полей на панели результатов.**

### Практические задания ###

```markdown
Добавьте к запросу еще одно поле и укажите для него псевдоним.
```

⚠️ Не используйте никакие ключевые слова SQL в качестве псевдонимов. Это вызовет путаницу или синтаксические ошибки.
РСУБД может интерпретировать данный псевдоним как команду

## Условие ORDER BY ##

Чтобы упорядочить полученные результаты по фамилии клиентов, надо использовать новое условие после условия `FROM`.
Условие `ORDER BY` используется для сортировки данных в порядке возрастания или убывания на основе одного или нескольких
столбцов. По умолчанию данные будут отсортированы в порядке возрастания от A до Z.
Специальное ключевое слово `ASC`, определяющее порядок сортировки, необязательно. Для сортировки в порядке
убывания от Z до A необходимо после сортируемого поля добавить ключевое слово `DESC`. Например,
запрос `ORDER BY LastName DESC` сортирует столбец с псевдонимом `LastName` в порядке убывания.

Если условие `ORDER BY` отсутствует, каждый запрос будет возвращать данные в том порядке, в котором они были изначально
сохранены в таблице.

```sqlite
/*
CREATED BY: O.SUROVTSEV
CREATED ON: 01/10/2023
DESCRIPTION: Данный запрос осуществляет выборку полей имени, фамилии 
и электронной почты из таблицы customers (клиенты), отсортированных 
по фамилии (Last Name).
*/
SELECT FirstName AS [First Name],
       LastName  AS [Last Name],
       Email     AS [EMAIL]
FROM customers
ORDER BY LastName ASC;
```

Также условие `ORDER BY` мы можем использовать для сортировки по нескольким столбцам. Cначала выполним сортировку по
имени (по алфавиту), а затем по фамилии (в обратном порядке). Для этого нам необходимо в условии `ORDER BY` указать два
поля. При перечислении нескольких полей их необходимо разделять запятыми.

```sqlite
/*
CREATED BY: O.SUROVTSEV
CREATED ON: 01/10/2023
DESCRIPTION: Данный запрос осуществляет выборку полей имени, фамилии 
и электронной почты из таблицы customers (клиенты), отсортированных 
сначала по имени (по возрастанию), а затем по фамилии (по убыванию). 
*/
SELECT FirstName AS [First name],
       LastName  AS [Last Name],
       Email     AS EMAIL
FROM customers
ORDER BY FirstName ASC,
         LastName DESC;
```

Если вы используете условие `ORDER BY` для столбца, в котором имеются пустые строки, вы увидите, что эти значения будут
отображаться в начале списка как `NULL` (если сортировка осуществляется в порядке возрастания).

### Практические задания ###

+ Измените порядок полей в условии `SELECT` и установите `LastName` первым столбцом, а не вторым. Выполните запрос, в
  результате которого будут получены упорядоченные записи `LastName`. Стал ли список более читабельным.

## Получение ограниченного числа записей с помощью условия LIMIT ##

Мы можем ограничить наши результаты определенным количеством строк. Это бывает полезно при сортировке по количеству,
например по самой высокой цене или самым большим продажам. Если после условия `ORDER BY` мы добавим ключевые
слова `LIMIT 10`, в результате вернутся только первые десять записей в указанном порядке сортировки.
Можно указать любое число записей, которое необходимо отобразить (при условии, что в таблице имеется такое количество
записей).

```sqlite
/*
CREATED BY: O.SUROVTSEV
CREATED ON: 01/10/2023
DESCRIPTION: Данный запрос осуществляет выборку первых 10 записей из 
таблицы customers (клиентов), отсортированных сначала по имени (по 
возрастанию), а затем по фамилии (по убыванию).
*/
SELECT FirstName AS [First Name],
       LastName  AS [Last Name],
       Email     AS EMAIL
FROM customers
ORDER BY FirstName ASC,
         LastName DESC
LIMIT 10;
```

Нет необходимости всегда использовать условие LIMIT вместе с ORDER BY. В большинстве случаев имеет смысл упорядочить
результаты по определенным критериям, прежде чем ограничивать их. Если условие ORDER BY не используется, результаты
оператора LIMIT будут возвращены в том порядке, в котором они были изначально добавлены в таблицу.

### Контрольные вопросы ###

1. Напишите запрос, чтобы узнать количество клиентов, фамилии которых начинаются с буквы B.
2. Какая компания при сортировке в порядке убывания появляется в верхней строке таблицы customers?
3. Какое количество клиентов не указали почтовый индекс?
